import React, { useState, useEffect } from 'react';
import { View, Text, TouchableOpacity, StyleSheet, useColorScheme, Alert, ScrollView, SafeAreaView } from 'react-native';
import { commonStyles } from '../styles/commonStyles';
import DashboardScreen from '../screens/DashboardScreen';
import PatientListScreen from '../screens/PatientListScreen';
import AddPatientScreen from '../screens/AddPatientScreen';
import AppointmentListScreen from '../screens/AppointmentListScreen';
import AddAppointmentScreen from '../screens/AddAppointmentScreen';
import AddMeasurementScreen from '../screens/AddMeasurementScreen';
import MeasurementDetailScreen from '../screens/MeasurementDetailScreen';
import AddDietPlanScreen from '../screens/AddDietPlanScreen';
import DietDetailScreen from '../screens/DietDetailScreen';
import DietPlanViewScreen from '../screens/DietPlanViewScreen';
import DoctorPendingApprovalsScreen from '../screens/DoctorPendingApprovalsScreen';
import { PatientDetailScreen } from '../screens/PatientDetailScreen';
import { Patient, Appointment, Measurement, DietPlan, User } from '../types';
import { PatientService } from '../services/patientService';
import { AuthService } from '../services/authService';
import { uploadMockDataToFirebase } from '../utils/uploadMockData';
import { mockPatients } from '../data/mockData';
import { testFirebaseConnection } from '../utils/testFirebase';
import { simpleFirebaseTest } from '../utils/simpleFirebaseTest';
import { debugFirebaseOperations } from '../utils/debugFirebase';
import { testInternetConnection, testFirebaseNetworkAccess } from '../utils/networkTest';

interface DoctorNavigatorProps {
  user: User;
  onLogout: () => void;
}

const DoctorNavigator: React.FC<DoctorNavigatorProps> = ({ user, onLogout }) => {
  const isDarkMode = useColorScheme() === 'dark';
  const [currentTab, setCurrentTab] = useState<'dashboard' | 'patients' | 'appointments' | 'measurements' | 'diets'>('dashboard');
  const [showAddPatient, setShowAddPatient] = useState(false);
  const [showAddAppointment, setShowAddAppointment] = useState(false);
  const [showAddMeasurement, setShowAddMeasurement] = useState(false);
  const [showMeasurementDetail, setShowMeasurementDetail] = useState(false);
  const [showAddDietPlan, setShowAddDietPlan] = useState(false);
  const [showDietDetail, setShowDietDetail] = useState(false);
  const [showDietPlanView, setShowDietPlanView] = useState(false);
  const [showPatientDetail, setShowPatientDetail] = useState(false);
  const [selectedPatientForAppointment, setSelectedPatientForAppointment] = useState<Patient | undefined>();
  const [selectedPatientForPatientDetail, setSelectedPatientForPatientDetail] = useState<Patient | undefined>();
  const [selectedPatientForMeasurement, setSelectedPatientForMeasurement] = useState<Patient | undefined>();
  const [selectedPatientForDetail, setSelectedPatientForDetail] = useState<Patient | undefined>();
  const [selectedPatientForDiet, setSelectedPatientForDiet] = useState<Patient | undefined>();
  const [selectedPatientForDietDetail, setSelectedPatientForDietDetail] = useState<Patient | undefined>();
  const [selectedDietPlan, setSelectedDietPlan] = useState<DietPlan | undefined>();
  const [patients, setPatients] = useState<Patient[]>([]);
  const [appointments, setAppointments] = useState<Appointment[]>([]);
  const [measurements, setMeasurements] = useState<Measurement[]>([]);
  const [dietPlans, setDietPlans] = useState<DietPlan[]>([]);
  const [loading, setLoading] = useState(true);

  // Firebase'den hastalarƒ± y√ºkle
  const loadPatients = async () => {
    try {
      setLoading(true);
      const fetchedPatients = await PatientService.getAllPatients();
      setPatients(fetchedPatients);
    } catch (error) {
      console.error('Hastalar y√ºklenemedi:', error);
      Alert.alert('Hata', 'Hastalar y√ºklenirken bir hata olu≈ütu.');
    } finally {
      setLoading(false);
    }
  };

  // Uygulama ba≈üladƒ±ƒüƒ±nda Firebase baƒülantƒ±sƒ±nƒ± test et ve hastalarƒ± y√ºkle
  useEffect(() => {
    const initializeApp = async () => {
      // √ñnce internet baƒülantƒ±sƒ±nƒ± test et
      console.log('üåê ƒ∞nternet baƒülantƒ±sƒ± kontrol ediliyor...');
      const internetResult = await testInternetConnection();
      
      if (!internetResult) {
        Alert.alert('ƒ∞nternet Hatasƒ±', 'ƒ∞nternet baƒülantƒ±sƒ± yok. L√ºtfen baƒülantƒ±nƒ±zƒ± kontrol edin.');
        setLoading(false);
        return;
      }
      
      // Firebase network eri≈üimini test et
      console.log('üî• Firebase network eri≈üimi test ediliyor...');
      const firebaseNetworkResult = await testFirebaseNetworkAccess();
      
      // Debug i≈ülemlerini √ßalƒ±≈ütƒ±r
      console.log('üöÄ Firebase debug i≈ülemleri ba≈ülatƒ±lƒ±yor...');
      const debugResult = await debugFirebaseOperations();
      
      if (debugResult) {
        console.log('‚úÖ Firebase debug testleri ba≈üarƒ±lƒ±');
        await loadPatients();
      } else {
        console.log('‚ùå Firebase debug testleri ba≈üarƒ±sƒ±z');
        Alert.alert(
          'Firebase Debug Hatasƒ±', 
          'Firebase temel i≈ülemleri ba≈üarƒ±sƒ±z. Konsol loglarƒ±nƒ± kontrol edin.',
          [
            { text: 'Offline Devam Et', onPress: () => setLoading(false) },
            { text: 'Yeniden Dene', onPress: () => initializeApp() },
            { 
              text: 'Mock Veri Y√ºkle', 
              onPress: () => {
                setPatients([...mockPatients.map(p => ({...p, id: Date.now().toString() + Math.random()}))]);
                setLoading(false);
              } 
            }
          ]
        );
      }
    };
    
    initializeApp();
  }, []);

  const handleAddPatient = async (patientData: Omit<Patient, 'id' | 'createdAt' | 'updatedAt'>) => {
    try {
      const newPatient = await PatientService.addPatient(patientData);
      setPatients(prev => [newPatient, ...prev]);
      setShowAddPatient(false);
      setCurrentTab('patients');
      Alert.alert('Ba≈üarƒ±lƒ±', 'Hasta ba≈üarƒ±yla kaydedildi!');
    } catch (error) {
      console.error('Hasta eklenemedi:', error);
      Alert.alert('Hata', 'Hasta kaydedilirken bir hata olu≈ütu.');
    }
  };

  const handlePatientPress = (patient: Patient) => {
    setSelectedPatientForPatientDetail(patient);
    setShowPatientDetail(true);
  };

  const handlePatientUpdated = (updatedPatient: Patient) => {
    setPatients(patients.map(p => p.id === updatedPatient.id ? updatedPatient : p));
  };

  const handleAddAppointmentFromPatient = (patient: Patient) => {
    setSelectedPatientForAppointment(patient);
    setShowAddAppointment(true);
  };

  const handleAddAppointmentFromList = () => {
    setSelectedPatientForAppointment(undefined);
    setShowAddAppointment(true);
  };

  const handleAppointmentSave = (appointment: Appointment) => {
    setShowAddAppointment(false);
    setSelectedPatientForAppointment(undefined);
    setCurrentTab('appointments');
    // Alert AddAppointmentScreen'de g√∂steriliyor, burada tekrar g√∂stermiyoruz
  };

  const handleAppointmentPress = (appointment: Appointment) => {
    // Future: Navigate to appointment detail screen
    console.log('Appointment pressed:', appointment.title);
  };

  const handleViewMeasurements = (patient: Patient) => {
    setSelectedPatientForDetail(patient);
    setShowMeasurementDetail(true);
  };

  const handleAddMeasurementFromPatient = (patient: Patient) => {
    setSelectedPatientForMeasurement(patient);
    setShowAddMeasurement(true);
  };

  const handleAddMeasurementFromList = () => {
    setSelectedPatientForMeasurement(undefined);
    setShowAddMeasurement(true);
  };

  const handleMeasurementSave = (measurement: Measurement) => {
    setMeasurements(prev => [measurement, ...prev]);
    setShowAddMeasurement(false);
    setSelectedPatientForMeasurement(undefined);
    setCurrentTab('measurements');
    Alert.alert('Ba≈üarƒ±lƒ±', '√ñl√ß√ºm ba≈üarƒ±yla eklendi!');
  };

  const handleViewDietPlans = (patient: Patient) => {
    setSelectedPatientForDietDetail(patient);
    setShowDietDetail(true);
  };

  const handleAddDietPlanFromPatient = (patient: Patient) => {
    setSelectedPatientForDiet(patient);
    setShowAddDietPlan(true);
  };

  const handleAddDietPlanFromList = () => {
    setSelectedPatientForDiet(undefined);
    setShowAddDietPlan(true);
  };

  const handleDietPlanSave = (dietPlan: DietPlan) => {
    setDietPlans(prev => [dietPlan, ...prev]);
    setShowAddDietPlan(false);
    setSelectedPatientForDiet(undefined);
    setCurrentTab('diets');
    Alert.alert('Ba≈üarƒ±lƒ±', 'Diyet planƒ± ba≈üarƒ±yla eklendi!');
  };

  const handleDietPlanPress = (dietPlan: DietPlan) => {
    console.log('Diet plan pressed:', dietPlan.title); // Debug log
    setSelectedDietPlan(dietPlan);
    setShowDietDetail(false); // √ñnce diet detail ekranƒ±nƒ± kapat
    // selectedPatientForDietDetail'i temizleme - hasta se√ßimini koru!
    setShowDietPlanView(true); // Sonra diet plan view'ƒ± a√ß
  };

  // Mock verileri Firebase'e y√ºkle (tek seferlik - geli≈ütirme ama√ßlƒ±)
  const handleUploadMockData = async () => {
    Alert.alert(
      'Mock Veriler',
      'Mock veriler Firebase\'e y√ºklensin mi? Bu i≈ülem sadece bir kez yapƒ±lmalƒ±dƒ±r.',
      [
        { text: 'ƒ∞ptal', style: 'cancel' },
        { 
          text: 'Y√ºkle', 
          onPress: async () => {
            try {
              await uploadMockDataToFirebase();
              await loadPatients(); // Listeyi yenile
              Alert.alert('Ba≈üarƒ±lƒ±', 'Mock veriler ba≈üarƒ±yla y√ºklendi!');
            } catch (error) {
              Alert.alert('Hata', 'Mock veriler y√ºklenirken hata olu≈ütu.');
            }
          }
        }
      ]
    );
  };

  if (showAddPatient) {
    return (
      <AddPatientScreen
        onSave={handleAddPatient}
        onCancel={() => setShowAddPatient(false)}
      />
    );
  }

  if (showAddAppointment) {
    return (
      <AddAppointmentScreen
        patients={patients}
        selectedPatient={selectedPatientForAppointment}
        user={user}
        onSave={handleAppointmentSave}
        onCancel={() => {
          setShowAddAppointment(false);
          setSelectedPatientForAppointment(undefined);
        }}
      />
    );
  }

  if (showAddMeasurement) {
    return (
      <AddMeasurementScreen
        patients={patients}
        selectedPatient={selectedPatientForMeasurement}
        onSave={handleMeasurementSave}
        onCancel={() => {
          setShowAddMeasurement(false);
          setSelectedPatientForMeasurement(undefined);
        }}
      />
    );
  }

  if (showMeasurementDetail && selectedPatientForDetail) {
    return (
      <MeasurementDetailScreen
        patient={selectedPatientForDetail}
        onBack={() => {
          setShowMeasurementDetail(false);
          setSelectedPatientForDetail(undefined);
        }}
        onAddMeasurement={handleAddMeasurementFromPatient}
      />
    );
  }

  if (showAddDietPlan) {
    return (
      <AddDietPlanScreen
        patients={patients}
        selectedPatient={selectedPatientForDiet}
        onSave={handleDietPlanSave}
        onCancel={() => {
          setShowAddDietPlan(false);
          setSelectedPatientForDiet(undefined);
        }}
      />
    );
  }

  if (showDietDetail && selectedPatientForDietDetail) {
    return (
      <DietDetailScreen
        patient={selectedPatientForDietDetail}
        onBack={() => {
          setShowDietDetail(false);
          setSelectedPatientForDietDetail(undefined);
        }}
        onAddDietPlan={handleAddDietPlanFromPatient}
        onDietPlanPress={handleDietPlanPress}
      />
    );
  }

  if (showPatientDetail && selectedPatientForPatientDetail) {
    return (
      <PatientDetailScreen
        patient={selectedPatientForPatientDetail}
        onBack={() => setShowPatientDetail(false)}
        onPatientUpdated={handlePatientUpdated}
      />
    );
  }

  if (showDietPlanView && selectedDietPlan) {
    return (
      <DietPlanViewScreen
        dietPlan={selectedDietPlan}
        onBack={() => {
          console.log('Closing diet plan view, returning to diet detail'); // Debug log
          console.log('Current selectedPatientForDietDetail:', selectedPatientForDietDetail?.firstName); // Debug log
          setShowDietPlanView(false);
          setSelectedDietPlan(undefined);
          // selectedPatientForDietDetail zaten set edilmi≈ü olmalƒ±, sadece DietDetailScreen'ƒ± a√ß
          setShowDietDetail(true); // Diet detail ekranƒ±na geri d√∂n
        }}
      />
    );
  }

  const handleLogout = async () => {
    Alert.alert(
      '√áƒ±kƒ±≈ü Yap',
      'Hesabƒ±nƒ±zdan √ßƒ±kmak istediƒüinizden emin misiniz?',
      [
        { text: 'ƒ∞ptal', style: 'cancel' },
        {
          text: '√áƒ±kƒ±≈ü Yap',
          onPress: async () => {
            try {
              await AuthService.logout();
              onLogout();
            } catch (error) {
              Alert.alert('Hata', '√áƒ±kƒ±≈ü yapƒ±lƒ±rken bir hata olu≈ütu');
            }
          },
        },
      ]
    );
  };

  return (
    <SafeAreaView style={[commonStyles.safeArea, isDarkMode && commonStyles.darkSafeArea]}>
      {/* Header */}
      <View style={[commonStyles.headerRow, isDarkMode && styles.darkHeader]}>
        <View style={styles.userInfo}>
          <Text style={[commonStyles.caption, isDarkMode && commonStyles.darkSubtitle]}>
            Ho≈ü geldiniz,
          </Text>
          <Text style={[commonStyles.title, isDarkMode && commonStyles.darkText]}>
            Dr. {user.firstName} {user.lastName}
          </Text>
        </View>
        <TouchableOpacity onPress={handleLogout} style={commonStyles.buttonDanger}>
          <Text style={commonStyles.buttonText}>üö™ √áƒ±kƒ±≈ü</Text>
        </TouchableOpacity>
      </View>

      {/* Tab Content */}
      <View style={styles.content}>
        {currentTab === 'dashboard' ? (
          <DashboardScreen />
        ) : currentTab === 'patients' ? (
          <PatientListScreen
            patients={patients}
            loading={loading}
            onPatientPress={handlePatientPress}
            onAddPatient={() => setShowAddPatient(true)}
            onUploadMockData={handleUploadMockData}
            onAddAppointment={handleAddAppointmentFromPatient}
            onViewMeasurements={handleViewMeasurements}
            onViewDietPlans={handleViewDietPlans}
          />
        ) : currentTab === 'appointments' ? (
          <AppointmentListScreen
            patients={patients}
            user={user}
            onAppointmentPress={handleAppointmentPress}
            onAddAppointment={handleAddAppointmentFromList}
          />
        ) : currentTab === 'measurements' ? (
          <View style={[commonStyles.container, isDarkMode && commonStyles.darkContainer]}>
            <View style={commonStyles.header}>
              <Text style={[commonStyles.titleLarge, isDarkMode && commonStyles.darkText]}>
                üìä √ñl√ß√ºm Takibi
              </Text>
              <Text style={[commonStyles.subtitle, isDarkMode && commonStyles.darkSubtitle]}>
                Hasta se√ßin veya yeni √∂l√ß√ºm ekleyin
              </Text>
            </View>
            
            <TouchableOpacity 
              style={commonStyles.buttonSuccess}
              onPress={handleAddMeasurementFromList}
            >
              <Text style={commonStyles.buttonText}>‚ûï Yeni √ñl√ß√ºm Ekle</Text>
            </TouchableOpacity>

            <ScrollView style={commonStyles.listContainer}>
              {patients.map((patient) => (
                <TouchableOpacity
                  key={patient.id}
                  style={[commonStyles.card, isDarkMode && styles.darkCard]}
                  onPress={() => handleViewMeasurements(patient)}
                >
                  <Text style={[commonStyles.title, isDarkMode && commonStyles.darkText]}>
                    {patient.firstName} {patient.lastName}
                  </Text>
                  <Text style={[commonStyles.caption, isDarkMode && commonStyles.darkSubtitle]}>
                    üë§ {patient.age} ya≈üƒ±nda ‚Ä¢ {patient.gender}
                  </Text>
                  <Text style={[styles.viewMeasurementsText, isDarkMode && commonStyles.darkSubtitle]}>
                    üìä √ñl√ß√ºmleri G√∂r√ºnt√ºle
                  </Text>
                </TouchableOpacity>
              ))}
            </ScrollView>
          </View>
        ) : (
          <View style={[commonStyles.container, isDarkMode && commonStyles.darkContainer]}>
            <View style={commonStyles.header}>
              <Text style={[commonStyles.titleLarge, isDarkMode && commonStyles.darkText]}>
                ü•ó Diyet Takibi
              </Text>
              <Text style={[commonStyles.subtitle, isDarkMode && commonStyles.darkSubtitle]}>
                Hasta se√ßin veya yeni diyet planƒ± ekleyin
              </Text>
            </View>
            
            <TouchableOpacity 
              style={[commonStyles.buttonPrimary, { backgroundColor: '#fd7e14' }]}
              onPress={handleAddDietPlanFromList}
            >
              <Text style={commonStyles.buttonText}>‚ûï Yeni Diyet Planƒ± Ekle</Text>
            </TouchableOpacity>

            <ScrollView style={commonStyles.listContainer}>
              {patients.map((patient) => (
                <TouchableOpacity
                  key={patient.id}
                  style={[commonStyles.card, isDarkMode && styles.darkCard]}
                  onPress={() => handleViewDietPlans(patient)}
                >
                  <Text style={[commonStyles.title, isDarkMode && commonStyles.darkText]}>
                    {patient.firstName} {patient.lastName}
                  </Text>
                  <Text style={[commonStyles.caption, isDarkMode && commonStyles.darkSubtitle]}>
                    üë§ {patient.age} ya≈üƒ±nda ‚Ä¢ {patient.gender}
                  </Text>
                  <Text style={[styles.viewMeasurementsText, { color: '#fd7e14' }, isDarkMode && commonStyles.darkSubtitle]}>
                    ü•ó Diyet Planlarƒ±nƒ± G√∂r√ºnt√ºle
                  </Text>
                </TouchableOpacity>
              ))}
            </ScrollView>
          </View>
        )}
      </View>

      {/* Bottom Tab Bar */}
      <View style={[commonStyles.tabContainer, { flexDirection: 'row', backgroundColor: '#ffffff', borderTopWidth: 1, borderTopColor: '#e5e7eb', paddingBottom: 20, paddingTop: 10 }, isDarkMode && styles.darkTabBar]}>
        <TouchableOpacity
          style={[
            commonStyles.tabButton,
            currentTab === 'dashboard' && commonStyles.tabButtonActive,
          ]}
          onPress={() => setCurrentTab('dashboard')}
        >
          <Text style={[
            styles.tabIcon,
            currentTab === 'dashboard' && styles.activeTabText,
          ]}>
            üìä
          </Text>
          <Text style={[
            commonStyles.tabButtonText,
            currentTab === 'dashboard' && commonStyles.tabButtonTextActive,
          ]}>
            Dashboard
          </Text>
        </TouchableOpacity>

        <TouchableOpacity
          style={[
            commonStyles.tabButton,
            currentTab === 'patients' && commonStyles.tabButtonActive,
          ]}
          onPress={() => setCurrentTab('patients')}
        >
          <Text style={[
            styles.tabIcon,
            currentTab === 'patients' && styles.activeTabText,
          ]}>
            üë•
          </Text>
          <Text style={[
            commonStyles.tabButtonText,
            currentTab === 'patients' && commonStyles.tabButtonTextActive,
          ]}>
            Hastalar
          </Text>
        </TouchableOpacity>

        <TouchableOpacity
          style={[
            commonStyles.tabButton,
            currentTab === 'appointments' && commonStyles.tabButtonActive,
          ]}
          onPress={() => setCurrentTab('appointments')}
        >
          <Text style={[
            styles.tabIcon,
            currentTab === 'appointments' && styles.activeTabText,
          ]}>
            üìÖ
          </Text>
          <Text style={[
            commonStyles.tabButtonText,
            currentTab === 'appointments' && commonStyles.tabButtonTextActive,
          ]}>
            Randevular
          </Text>
        </TouchableOpacity>


        <TouchableOpacity
          style={[
            commonStyles.tabButton,
            currentTab === 'measurements' && commonStyles.tabButtonActive,
          ]}
          onPress={() => setCurrentTab('measurements')}
        >
          <Text style={[
            styles.tabIcon,
            currentTab === 'measurements' && styles.activeTabText,
          ]}>
            üìä
          </Text>
          <Text style={[
            commonStyles.tabButtonText,
            currentTab === 'measurements' && commonStyles.tabButtonTextActive,
          ]}>
            √ñl√ß√ºmler
          </Text>
        </TouchableOpacity>

        <TouchableOpacity
          style={[
            commonStyles.tabButton,
            currentTab === 'diets' && commonStyles.tabButtonActive,
          ]}
          onPress={() => setCurrentTab('diets')}
        >
          <Text style={[
            styles.tabIcon,
            currentTab === 'diets' && styles.activeTabText,
          ]}>
            ü•ó
          </Text>
          <Text style={[
            commonStyles.tabButtonText,
            currentTab === 'diets' && commonStyles.tabButtonTextActive,
          ]}>
            Diyet
          </Text>
        </TouchableOpacity>
      </View>
    </SafeAreaView>
  );
};

  const handleLogout = async () => {
    Alert.alert(
      '√áƒ±kƒ±≈ü Yap',
      'Hesabƒ±nƒ±zdan √ßƒ±kmak istediƒüinizden emin misiniz?',
      [
        { text: 'ƒ∞ptal', style: 'cancel' },
        {
          text: '√áƒ±kƒ±≈ü Yap',
          onPress: async () => {
            try {
              await AuthService.logout();
              onLogout();
            } catch (error) {
              Alert.alert('Hata', '√áƒ±kƒ±≈ü yapƒ±lƒ±rken bir hata olu≈ütu');
            }
          },
        },
      ]
    );
  };

const styles = StyleSheet.create({
  content: {
    flex: 1,
  },
  
  darkTabBar: {
    backgroundColor: '#262626',
    borderTopColor: '#404040',
  },
  
  tabIcon: {
    fontSize: 20,
    marginBottom: 4,
    opacity: 0.7,
  },
  
  activeTabText: {
    color: '#6366f1',
    fontWeight: '600',
  },
  
  viewMeasurementsText: {
    fontSize: 14,
    color: '#10b981',
    fontWeight: '500',
    textAlign: 'center',
    marginTop: 4,
  },
  
  darkCard: {
    backgroundColor: '#262626',
  },
  
  darkHeader: {
    backgroundColor: '#262626',
    borderBottomColor: '#404040',
  },
});


export default DoctorNavigator;